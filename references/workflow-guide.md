# 多渠道接入工作流程指南

## 目录
1. [系统架构](#系统架构)
2. [消息接入流程](#消息接入流程)
3. [订单处理流程](#订单处理流程)
4. [预订处理流程](#预订处理流程)
5. [常见场景处理](#常见场景处理)
6. [异常处理](#异常处理)

---

## 系统架构

### 整体架构
```
客户渠道 → AI代理 → 数据表格
├── 微信       ├─ 意图识别    ├─ 菜单查询
├── 抖音       ├─ 信息提取    ├─ 订单记录
├── 美团       ├─ 数据验证    └─ 预订管理
├── 淘宝       └─ 脚本调用
└── 电话       └─ 响应生成
```

### 角色分工
- **AI智能体**:
  * 理解客户自然语言意图
  * 识别业务场景（点餐/预订/咨询）
  * 提取关键信息（菜品、时间、联系方式）
  * 生成自然语言回复
  * 调用脚本处理数据操作

- **脚本**:
  * 执行菜单查询和推荐
  * 写入和读取订单数据
  * 查询可用时段
  * 创建和管理预订

---

## 消息接入流程

### 步骤1: 消息接收
- 各渠道消息统一接入AI代理
- 标记渠道来源（微信/抖音/美团/淘宝/电话）

### 步骤2: 意图识别
AI代理分析消息内容，识别用户意图:
- **点餐意图**: "我要点外卖"、"想吃宫保鸡丁"、"给我来一份麻婆豆腐"
- **预订意图**: "我要预订"、"明晚8点有个位置"、"需要订个桌"
- **咨询意图**: "有什么菜"、"宫保鸡丁多少钱"、"你们营业到几点"
- **订单查询**: "我的订单到哪了"、"什么时候送"

### 步骤3: 信息提取
根据意图提取关键信息:
- 点餐: 菜品名称、数量、联系方式、地址
- 预订: 日期、时间、人数、联系方式
- 咨询: 查询关键词
- 订单查询: 订单号、电话号码

### 步骤4: 数据验证
验证提取信息的完整性和有效性:
- 电话号码格式（11位数字）
- 菜品是否在菜单中且可售
- 预订日期和时段是否有效
- 地址信息是否完整（外卖）

---

## 订单处理流程

### 标准流程

1. **接收点餐请求**
   - 用户: "我要点宫保鸡丁和麻婆豆腐，送到朝阳区xx路，电话13800138000"
   - AI识别意图: 点餐

2. **提取订单信息**
   - 客户姓名: （如未提供，需询问）
   - 电话号码: 13800138000
   - 配送地址: 朝阳区xx路
   - 菜品清单: [{"菜品ID":"M001","数量":1},{"菜品ID":"M002","数量":1}]
   - 渠道来源: （当前渠道）

3. **验证信息完整性**
   - 调用脚本查询菜单验证菜品
   - 检查菜品是否可售
   - 计算总金额
   - 如信息缺失，向用户询问

4. **确认订单**
   - AI生成确认消息: "您的订单: 宫保鸡丁(1份) ¥38.00 + 麻婆豆腐(1份) ¥28.00 = ¥66.00，配送至朝阳区xx路，联系电话13800138000，确认吗？"
   - 用户确认后继续

5. **记录订单**
   - 调用 `scripts/order_manager.py` 写入订单
   - 生成订单ID
   - 订单状态设为"待确认"

6. **返回订单信息**
   - AI回复: "订单已创建，订单号: ORD20250115001，预计30分钟内送达"

### 示例对话

**示例1: 完整点餐**
```
用户: 我要点宫保鸡丁和麻婆豆腐，送到朝阳区建国路88号，电话13800138000
AI: 好的，您的订单如下:
    宫保鸡丁 1份 ¥38.00
    麻婆豆腐 1份 ¥28.00
    总计: ¥66.00
    配送地址: 朝阳区建国路88号
    联系电话: 13800138000
    确认下单吗？

用户: 确认
AI: 订单已创建成功！
    订单号: ORD20250115001
    状态: 待确认
    预计送达时间: 30分钟
```

**示例2: 咨询菜品后点餐**
```
用户: 你们有什么热菜推荐吗？
AI: (调用脚本查询热菜) 我们的热菜有:
    宫保鸡丁 ¥38.00 - 经典川菜，麻辣鲜香
    麻婆豆腐 ¥28.00 - 嫩滑豆腐，麻辣下饭
    水煮鱼 ¥68.00 - 鲜嫩鱼片，麻辣香浓
    您想点哪道菜？

用户: 给我来份宫保鸡丁和麻婆豆腐
AI: 好的，请问您的姓名和联系电话、配送地址？

用户: 张三，13800138000，朝阳区建国路88号
AI: 订单确认:
    宫保鸡丁 1份 ¥38.00
    麻婆豆腐 1份 ¥28.00
    总计: ¥66.00
    配送地址: 朝阳区建国路88号
    联系人: 张三 13800138000
    确认下单吗？

用户: 确认
AI: 订单已创建成功！订单号: ORD20250115001
```

---

## 预订处理流程

### 标准流程

1. **接收预订请求**
   - 用户: "明晚7点预订4人桌"
   - AI识别意图: 预订

2. **提取预订信息**
   - 预订日期: 明晚的日期
   - 时段: 19:00-21:00（基于7点推算）
   - 人数: 4人
   - 联系方式: （如未提供，需询问）

3. **查询可用时段**
   - 调用 `scripts/reservation_manager.py` 查询该日期的可用时段
   - 检查时段容量是否满足人数要求

4. **推荐或确认**
   - 如请求时段可用: "19:00-21:00时段可用，请提供您的姓名和电话确认"
   - 如请求时段已满: "19:00-21:00已满，推荐18:00-20:00或20:00-22:00，您看可以吗？"

5. **验证信息**
   - 确认姓名、电话号码

6. **创建预订**
   - 调用 `scripts/reservation_manager.py` 创建预订
   - 生成预订ID
   - 预订状态设为"已确认"

7. **返回预订信息**
   - AI回复: "预订已创建，预订号: RES20250115001，期待您的光临"

### 示例对话

**示例1: 直接预订**
```
用户: 明天晚上7点要预订4人桌
AI: 好的，2025年1月16日19:00-21:00时段可预订4人桌
    请提供您的姓名和联系电话

用户: 李四，13900139000
AI: 预订信息确认:
    日期: 2025年1月16日
    时段: 19:00-21:00
    人数: 4人
    联系人: 李四 13900139000
    确认预订吗？

用户: 确认
AI: 预订已创建成功！
    预订号: RES20250116001
    我们期待您的光临
```

**示例2: 时段冲突处理**
```
用户: 明天晚上7点要预订4人桌
AI: (调用脚本查询) 2025年1月16日19:00-21:00时段已满
    推荐以下可用时段:
    - 18:00-20:00（可容纳4人）
    - 20:00-22:00（可容纳4人）
    您希望选择哪个时段？

用户: 18:00-20:00吧
AI: 好的，2025年1月16日18:00-20:00时段可预订4人桌
    请提供您的姓名和联系电话

用户: 王五，13700137000
AI: 预订信息确认:
    日期: 2025年1月16日
    时段: 18:00-20:00
    人数: 4人
    联系人: 王五 13700137000
    确认预订吗？

用户: 确认
AI: 预订已创建成功！
    预订号: RES20250116001
```

---

## 常见场景处理

### 场景1: 菜单咨询
```
用户: 你们有什么菜品？
AI: (调用脚本查询菜单) 我们的菜单如下:
    【热菜】
    宫保鸡丁 ¥38.00 - 经典川菜，麻辣鲜香
    麻婆豆腐 ¥28.00 - 嫩滑豆腐，麻辣下饭

    【凉菜】
    凉拌黄瓜 ¥15.00 - 清爽开胃，简单美味

    【主食】
    扬州炒饭 ¥25.00 - 经典扬州风味

    【饮料】
    可口可乐 ¥5.00 - 330ml罐装

    【甜点】
    提拉米苏 ¥18.00 - 意式经典甜品
    您想点哪道菜？

用户: 宫保鸡丁多少钱？
AI: 宫保鸡丁 ¥38.00，是经典川菜，麻辣鲜香
```

### 场景2: 菜品推荐
```
用户: 推荐2个热菜
AI: (调用脚本查询热菜并推荐) 我推荐:
    1. 宫保鸡丁 ¥38.00 - 经典川菜，麻辣鲜香
    2. 麻婆豆腐 ¥28.00 - 嫩滑豆腐，麻辣下饭
    合计 ¥66.00
    需要下单吗？
```

### 场景3: 订单查询
```
用户: 查询订单ORD20250115001
AI: (调用脚本查询订单) 订单信息:
    订单号: ORD20250115001
    客户: 张三
    电话: 13800138000
    菜品: 宫保鸡丁(1份)、麻婆豆腐(1份)
    总金额: ¥66.00
    状态: 配送中
    预计送达: 10分钟内
```

### 场景4: 预订查询
```
用户: 查询我明天的预订，电话13900139000
AI: (调用脚本查询预订) 您的预订信息:
    预订号: RES20250116001
    日期: 2025年1月16日
    时段: 18:00-20:00
    人数: 4人
    状态: 已确认
```

### 场景5: 订单取消
```
用户: 取消订单ORD20250115001
AI: (调用脚本更新订单状态) 订单ORD20250115001已取消
    如需重新下单，请告知
```

---

## 异常处理

### 菜品相关异常
- **菜品不存在**: "抱歉，该菜品暂未提供，请问需要推荐其他菜品吗？"
- **菜品已售罄**: "抱歉，该菜品暂时售罄，请问需要推荐其他菜品吗？"

### 订单相关异常
- **信息不完整**: "请提供完整的订单信息（姓名、电话、地址、菜品）"
- **订单不存在**: "未找到该订单，请确认订单号是否正确"
- **地址无效**: "配送地址信息不完整，请提供详细地址"

### 预订相关异常
- **时段已满**: "该时段已满，推荐以下时段: ..."
- **预订日期无效**: "请选择今天或未来的日期"
- **人数超过容量**: "抱歉，该时段最大可容纳XX人，请问需要分批预订吗？"

### 系统异常
- **数据写入失败**: "系统繁忙，请稍后重试"
- **查询超时**: "查询超时，请稍后重试"
- **网络异常**: "网络连接异常，请检查网络后重试"

---

## 渠道特性处理

### 微信
- 支持语音消息转文字
- 支持图片识别（如查看菜单图片）
- 消息长度限制: 2048字符

### 抖音
- 支持短视频评论互动
- 需适应抖音用户表达习惯（更口语化）

### 美团/淘宝
- 预定义消息模板
- 订单状态同步
- 支付流程集成（如需）

### 电话
- 语音识别转文字
- 需更强的上下文理解能力
- 对话引导更主动

---

## 响应格式规范

### 成功响应格式
```
✅ [操作类型] 成功
详细信息: ...
订单号/预订号: XXXXXXXXX
```

### 确认请求格式
```
请确认以下信息:
- 信息项1: XXX
- 信息项2: XXX
...
确认吗？(是/否)
```

### 错误响应格式
```
❌ [错误类型]
原因: ...
建议: ...
```

---

## 注意事项

1. **信息收集完整性**: 确保在执行操作前收集所有必要信息
2. **用户体验**: 使用友好的自然语言，避免技术术语
3. **数据验证**: 在写入数据前验证所有字段的有效性
4. **异常处理**: 提供清晰的错误信息和解决方案
5. **确认机制**: 重要操作需用户确认后才执行
6. **渠道适配**: 根据不同渠道特性调整交互方式
